---
import { getCollection } from 'astro:content';
import BaseLayout from '@/layouts/BaseLayout.astro';
import Header from '@/components/Header.astro';
import Footer from '@/components/Footer.astro';

const projects = (await getCollection('projects')).sort(
  (a, b) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime()
);
const allTags = [...new Set(projects.flatMap((project) => project.data.tags))].sort();
---

<BaseLayout title="Projects | Fumiya Morishita" pathname="/projects">
  <Header />
  <main class="section">
    <div class="container-base">
      <h1 class="text-4xl font-semibold md:text-6xl">Projects</h1>
      <p class="mt-4 max-w-2xl leading-relaxed text-neutral-700">タイトル・技術タグで検索し、関心のあるテーマだけを絞り込めます。</p>

      <div class="mt-10 grid gap-4 rounded-xl border border-neutral-200 p-6 md:grid-cols-[1fr_auto] md:items-end">
        <label class="block">
          <span class="mb-2 block text-sm font-medium">検索</span>
          <input id="search" type="search" placeholder="タイトルまたは技術タグを入力" class="w-full rounded-md border border-neutral-300 px-3 py-2 text-sm" aria-label="プロジェクト検索" />
        </label>
        <label class="block">
          <span class="mb-2 block text-sm font-medium">タグ</span>
          <select id="tagFilter" class="rounded-md border border-neutral-300 px-3 py-2 text-sm" aria-label="タグフィルター">
            <option value="all">すべて</option>
            {allTags.map((tag) => <option value={tag}>{tag}</option>)}
          </select>
        </label>
      </div>

      <div id="projectsGrid" class="mt-10 grid gap-6 md:grid-cols-2 xl:grid-cols-3">
        {projects.map((project) => (
          <article class="project-card rounded-xl border border-neutral-200 p-6" data-title={project.data.title.toLowerCase()} data-tags={project.data.tags.join(',').toLowerCase()} data-date={project.data.date}>
            <p class="text-xs text-neutral-500">{project.data.date}</p>
            <h2 class="mt-3 text-xl font-medium">{project.data.title}</h2>
            <p class="mt-3 leading-relaxed text-neutral-700">{project.data.summary}</p>
            <div class="mt-4 flex flex-wrap gap-2">
              {project.data.tags.map((tag) => <span class="rounded bg-neutral-100 px-2.5 py-1 text-xs text-neutral-700">{tag}</span>)}
            </div>
            <a href={`/projects/${project.slug}`} class="mt-6 inline-block text-sm text-accent hover:underline">詳細へ</a>
          </article>
        ))}
      </div>
      <p id="emptyState" class="mt-8 hidden text-sm text-neutral-500">一致するプロジェクトがありません。</p>
    </div>
  </main>
  <Footer />

  <script>
    const searchInput = document.querySelector('#search');
    const tagFilter = document.querySelector('#tagFilter');
    const cards = [...document.querySelectorAll('.project-card')];
    const emptyState = document.querySelector('#emptyState');

    const sortByDateDesc = () => {
      const grid = document.querySelector('#projectsGrid');
      cards
        .sort((a, b) => new Date(b.dataset.date).getTime() - new Date(a.dataset.date).getTime())
        .forEach((card) => grid.appendChild(card));
    };

    const filterProjects = () => {
      const keyword = searchInput.value.trim().toLowerCase();
      const selectedTag = tagFilter.value.toLowerCase();

      let visibleCount = 0;
      cards.forEach((card) => {
        const hitKeyword = card.dataset.title.includes(keyword) || card.dataset.tags.includes(keyword);
        const hitTag = selectedTag === 'all' || card.dataset.tags.includes(selectedTag);
        const visible = hitKeyword && hitTag;
        card.classList.toggle('hidden', !visible);
        if (visible) visibleCount += 1;
      });

      emptyState.classList.toggle('hidden', visibleCount !== 0);
    };

    sortByDateDesc();
    searchInput?.addEventListener('input', filterProjects);
    tagFilter?.addEventListener('change', filterProjects);
  </script>
</BaseLayout>
